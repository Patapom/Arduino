var Oauth2=function(){function t(e){if(window.self===window.top){localStorage.removeItem("oauth_token"),this.opts=this.defaults(e);var t=this.getCookie("arduino_authenticated");t&&"false"!==t||sessionStorage.removeItem("oauth_token");var o=sessionStorage.getItem("oauth_clientId");o&&this.opts.clientID!==o&&sessionStorage.removeItem("oauth_token");var r=this.getTokenFromHash(window.location,this.opts.params);if(""!==r.token)return this.putInSession(r),void this.redirect();sessionStorage.setItem("oauth_redirect",window.location.href),sessionStorage.setItem("oauth_clientId",this.opts.clientID)}}return t.prototype.login=function(e){sessionStorage.setItem("oauth_redirect",e||window.location.href),window.location.href=this.redirectURI()},t.prototype.logout=function(e){sessionStorage.removeItem("oauth_redirect"),sessionStorage.removeItem("oauth_token"),sessionStorage.removeItem("oauth_clientId"),window.location.href=this.logoutURI(e)},t.prototype.redirectURI=function(){var e=encodeURIComponent(this.opts.redirectURI),t=Math.random().toString(36).substr(2,8),o=this.opts.scopes.join("%20");return this.opts.authURI+"?client_id="+this.opts.clientID+"&state="+t+"&scope="+o+"&response_type=token&redirect_uri="+e},t.prototype.logoutURI=function(e){var t;return t=e?encodeURIComponent(e):encodeURIComponent(this.opts.redirectURI),this.opts.logoutURI+"?redirect_uri="+t},t.prototype.tokenPromise=void 0,t.prototype.token=function(){if(window.self!==window.top)return Promise.reject("inside iframe");var e;e=this.getFromSession();var r=new Date(Date.now()-1e4),n=this;return e&&e.expires&&e.expires<r&&(t.prototype.tokenPromise=void 0),t.prototype.tokenPromise||(t.prototype.tokenPromise=new Promise(function(t,o){return e&&e.expires&&e.expires>r?t(e):"true"===n.getCookie("arduino_authenticated")?n.refresh().then(function(e){return t(e)}).catch(function(e){return o(e)}):o("LOGGED OUT")})),t.prototype.tokenPromise},t.prototype.redirect=function(){var e=sessionStorage.getItem("oauth_redirect");e&&(sessionStorage.removeItem("oauth_redirect"),window.location.href=e)},t.prototype.defaults=function(e){return e.params||(e.params={}),e.params.token||(e.params.token="access_token"),e.params.expires||(e.params.expires="expires_in"),e.params.type||(e.params.type="token_type"),e.params.scope||(e.params.scope="scope"),e.authURI||console.error("Oauth2: the property authURI is missing"),e},t.prototype.refresh=function(){var i=this;return new Promise(function(t,o){var r=document.createElement("iframe");r.setAttribute("src",i.redirectURI()),r.setAttribute("height","0"),r.setAttribute("width","0");var n=i.getTokenFromHash;r.onload=function(){var e=n(this.contentWindow.location,i.opts.params);document.body.removeChild(r),""===e.token?o("token not found"):(i.putInSession(e),t(e))},r.onerror=function(e){o(e)},document.body.appendChild(r)})},t.prototype.getTokenFromHash=function(e,t){function o(e,t){for(var o=0;o<e.length;o++){var r=e[o].split("="),n=r[0],i=r[1];if(n===t)return i}return""}var r,n={token:"",scope:"",expires:new Date(0),type:""};try{r=e.hash.substring(1)}catch(e){return n}var i=r.split("&");n.token=o(i,t.token);var s=parseInt(o(i,t.expires));return n.expires=new Date(Date.now()+1e3*s),n.scope=o(i,t.scope),n.type=o(i,t.type),n},t.prototype.putInSession=function(e){if("object"==typeof e){var t=JSON.stringify(e);sessionStorage.setItem("oauth_token",t)}},t.prototype.getFromSession=function(){var e=sessionStorage.getItem("oauth_token");try{var t=JSON.parse(e);return t.expires=new Date(t.expires),t}catch(e){return null}},t.prototype.getCookie=function(e){var t=" "+document.cookie,o=t.indexOf(" "+e+"=");if(-1===o)t=null;else{o=t.indexOf("=",o)+1;var r=t.indexOf(";",o);-1===r&&(r=t.length),t=decodeURI(t.substring(o,r))}return t},t}();