ws.namespace("ws.stream");ws.stream=function($,undefined){$(document).ready(function(){$.timeago.settings.allowFuture=true;$(window).scroll(pageCheck);$(".ws-stream-form-discussion .ws-track.add-content-toggle").each(function(){$(this).data("track-props",function(){var $el=$(this);var value=$el.hasClass("active")?"off":"on";var page=$el.closest(".tc-timeline").length?"announcement":"resource";return{"page":page,"value":value}})});$(".ws-stream-form-discussion").on("submit",function(e){var success=true;var $el=$(this);if(!$el.find(".js-discussion-subject").val()||!$(this).find(".js-discussion-body").val()){e.preventDefault();e.stopImmediatePropagation();window.alert("Please enter a subject and body before posting.");success=false}var page=$el.closest(".tc-timeline").length?"announcement":"resource";ws.common.trackMp("DiscussionPostConfirm",{"success":success,"page":page})});var $form=$(".ws-stream-form");$form.on("ws-ajax-submit",function(e,ajax){var form=this;ajax.always(function(){_.defer(function(){$(form).find('[data-toggle="buttons"] > .btn > input').filter('[type="radio"], [type="checkbox"]').each(function(){var $this=$(this);$this.closest(".btn").toggleClass("active",$this.prop("checked"))})})})});$(".calendar-day-with-event a").on({"click":function(){var eventIdClass=_($(this).parent().attr("class").split(" ")).find(function(cls){return cls.match(/^event-\d+/)});if(eventIdClass){var eventId=parseInt(eventIdClass.match(/event-(\d+)/)[1],10);ws.dialog.frameDialog(ws.common.pathFor("event","view",eventId))}}});$("body").on({"mouseenter":function(){$(this).addClass("ws-hovering")},"mouseleave":function(){$(this).removeClass("ws-hovering")}},".tc-timeline-box");$form.on("ws-ajax-submit",function(e,ajax){ajax.done(function(data){if(data&&data.share){shares.unshift(data.share);ws.stream.sharesUpdated(true);ws.stream.closeAddBlock();ws.stream.highlightNewestShare();$(".ws-stream-form").trigger("create:share")}})});$(".ws-stream-form-event").on("ws-ajax-submit",function(e,ajax){ajax.done(function(data){if(data&&data.event)upcoming.add(data.event)})})});var pageCheck=function(){var $pager=$(".js-pager");if($pager.length&&$pager.is(":inView")){var nextPage=$pager.data("nextPage");$pager.replaceWith($('<div id="js-tc-stream-page-spinner"><i class="fa fa-spinner fa-spin"/></div>'));ws.common.ajax({"queueName":"sharePage","url":ws.stream.shareSource,"type":"GET","data":{"page":nextPage}}).done(function(data){if(data&&data.sharePage)ws.stream.addSharePage(data.sharePage)}).always(function(){$("#js-tc-stream-page-spinner").remove()})}};var calculateVerticalLineHeight=function(){_.delay(function(){if(ws.stream.hideTimeline)return;var height=jQuery(".timeline").height()-22-40-20;var $line=$(".timeline-line");if(0===$(".tc-timeline-block").not(".tc-add-block").first().length){$line.height(0);return}$line.height(height)},210)};var closeAddBlock=function(){var $el=$(".tc-add-block");if(!$el.hasClass("add-block-active"))return;$el.addClass("ws-track");$el.removeClass("add-block-active");$(".tc-add-block-content").hide();$("#ws-form-message-subject").blur();calculateVerticalLineHeight()};var openAddBlock=function(){var $el=$(this);if($el.hasClass("add-block-active"))return;$el.removeClass("ws-track");$el.addClass("add-block-active");$(".tc-add-block-content").show();$("#ws-form-message-subject").focus();calculateVerticalLineHeight();ws.common.trackMp("AnnouncementCreate")};var Share=Backbone.Model.extend({"initialize":function(){var esto=this;if(ws.comments.Manager){this.on("change",function(){var comment=ws.comments.Manager.commentById(esto.id);if(comment)comment.update(esto.attributes,{"silent":true})});this.on("destroy",function(){var comment=ws.comments.Manager.commentById(esto.id);if(comment)comment.remove({"silent":true})})}},"sync":function(method){if("update"===method)return ws.common.ajax({"url":ws.common.pathFor("share","update",this.id),"data":{"locked":this.get("locked"),"monitored":this.get("monitored")}});else if("delete"===method){var shareId=this.id;var title=this.get("title");return ws.common.ajax({"url":ws.common.pathFor("share","delete",shareId)}).done(function(){var callback=function(){window.location.reload(true)};ws.stream.showUndoShareLink(shareId,title,callback);ws.stream.sharesUpdated(true)})}else throw"Not implemented."},"addReply":function(message,callback){var esto=this;return ws.common.ajax({"url":ws.common.pathFor("share","reply",this.id),"data":{"body":message}}).done(function(response){esto.set(response);if(callback)callback()})},"removeReply":function(replyId){var esto=this;return ws.common.ajax({"url":ws.common.pathFor("message","delete","$",replyId)}).done(function(){}).always(function(){esto.set("removeReplyCount",(esto.get("removeReplyCount")||1)-1);if(0===esto.get("removeReplyCount")){esto.unset("removeReplyCount");var $spinnerParent=$('.tc-timeline-box[data-id="'+esto.id+'"]').find(".tc-box-title");var $spinner=$spinnerParent.find(".fa-spinner");if($spinner.length>0)$spinner.remove()}})},"addReplyPage":function(pageNum){var esto=this;return ws.common.ajax({"url":ws.common.pathFor("share","replies",this.id),"data":{"page":pageNum,"timestamp":this.get("dateDigested")}}).done(function(response){var pages=esto.get("replyPages");pages.unshift(response);esto.set("replyPages",pages);esto.trigger("change:replyPages")})},"toggleLocked":function(){this.save({"locked":!this.get("locked")})},"toggleMonitor":function(){this.save({"monitored":!this.get("monitored")})}});var SharesList=Backbone.Collection.extend({"model":Share});var shares=new SharesList;var ShareView=Backbone.View.extend({"tagName":"div","template":_.template($("#js-share-template").html()),"events":{"click .js-toggle-lock":"toggleLocked","click .js-toggle-monitor":"toggleMonitor","click .ws-reveal.tc-timeline-box-header":"revealHeader","focus .ws-reveal.tc-timeline-box-header":"revealHeader","click .ws-reveal.reply":"revealReply","focus .ws-reveal.reply":"revealReply","click .js-destroy-share":"destroyMe","click .add-reply":"addReply","click .destroy-message":"removeReply"},"initialize":function(){this.model.bind("change:replyPages",this.render,this);this.model.bind("change:locked",this.lockChange,this);this.model.bind("change:monitored",this.monitorChange,this);this.model.bind("destroy",this.remove,this);this.model.bind("remove",this.remove,this)},"render":function(){this.$el.html(this.template(this.model.toJSON()));this.lockChange();this.monitorChange();this.$el.find(".ws-tip").tooltip({"container":this.$el});_.defer(function(){$(".calendar-day-with-event").tooltip({"container":$(".WikispacesContent, body")});$("abbr.timeago").timeago()});return this},"lockChange":function(){this.$el.find(".js-toggle-lock span").text(this.model.get("locked")?"Unlock Replies":"Lock Replies")},"monitorChange":function(){this.$el.find(".js-toggle-monitor span").text(this.model.get("monitored")?"Stop Monitoring":"Start Monitoring")},"toggleLocked":function(){this.model.toggleLocked();var $menu=this.$el.find(".dropdown-toggle");if($menu.is(":visible"))$menu.dropdown("toggle");return false},"toggleMonitor":function(){this.model.toggleMonitor();var $menu=this.$el.find(".dropdown-toggle");if($menu.is(":visible"))$menu.dropdown("toggle");return false},"addReply":function(){var esto=this;var replyText=this.$el.find("textarea.reply").val();if(!replyText){window.alert("Please add your reply before posting.");return}this.model.addReply(replyText,function(){esto.$el.find("textarea.reply").val("");esto.$el.addClass("add-active");esto.$el.trigger("change:addReply");calculateVerticalLineHeight()})},"removeReply":function(evt){var $mediaBody=$(evt.target).parents(".media-body");var replyId=$mediaBody.data("id");$mediaBody.parent(".tc-timeline-comment").hide();var $spinnerParent=$('.tc-timeline-box[data-id="'+this.model.id+'"]').find(".tc-box-title");var $spinner=$spinnerParent.find(".fa-spinner");if(0===$spinner.length){$spinner=$('<i class="fa fa-spinner fa-spin" style="margin-left: 5px;"></i>');$spinnerParent.append($spinner)}this.model.set("removeReplyCount",(this.model.get("removeReplyCount")||0)+1);this.model.removeReply(replyId);calculateVerticalLineHeight()},"revealReply":function(evt){var $elem=evt?$(evt.target):$("#js-share-list .tc-timeline-box textarea").eq(0);if(!$elem.closest(".ws-reveal").hasClass("ws-unrevealed"))return;$elem.closest(".ws-reveal").removeClass("ws-unrevealed");$elem.parent().parent(".tc-add-comment").addClass("add-active");$elem.trigger("reveal");calculateVerticalLineHeight()},"revealHeader":function(evt){var $elem=$(evt.target);$elem.closest(".ws-reveal").removeClass("ws-unrevealed").closest(".media-body").find(".hidden").slideDown({"complete":function(){$elem.trigger("reveal");calculateVerticalLineHeight()}})},"destroyMe":function(){this.model.destroy();calculateVerticalLineHeight();return false}});var ShareListView=Backbone.View.extend({"el":$("#js-share-list"),"initialize":function(){shares.bind("add",this.addOne,this);shares.bind("reset",this.addAll,this)},"addOne":function(share){var view=new ShareView({"model":share});if(0===share.collection.indexOf(share))this.$el.prepend($(view.render().el));else this.$el.append(view.render().el)},"addAll":function(shares){_(shares).each(function(share){var view=new ShareView({"model":share});this.$el.append(view.render().el)}.bind(this))},"appendEndBlock":function(){if(ws.stream.hideTimeline)return;if(0===ws.stream.shares.length)return;if($(".tc-end-block").length>0)return;this.$el.append(_.template($("#js-stream-end-template").html()))},"detachEndBlock":function(){var $endBlock=$(".tc-end-block");if($endBlock.length>0)$endBlock.detach()}});var shareListView=new ShareListView;var Event=Backbone.Model.extend({});var EventsList=Backbone.Collection.extend({"model":Event});var upcoming=new EventsList;upcoming.comparator=function(up){return up.get("start")};upcoming.on("change reset add",function(){$(".ws-event-row").toggle(upcoming.length>0)});var EventView=Backbone.View.extend({"tagName":"li","template":_.template($("#js-event-template").html()),"initialize":function(){this.model.bind("change",this.render,this)},"render":function(){this.$el.html(this.template(this.model.toJSON()));return this}});var EventListView=Backbone.View.extend({"el":$("#js-event-list"),"initialize":function(){upcoming.bind("add",this.addOne,this);upcoming.bind("reset",this.addAll,this)},"addOne":function(){this.addAll()},"addAll":function(){this.$el.find("li:not(.js-event-list-link)").remove();var esto=this;upcoming.each(function(event){var view=new EventView({"model":event});esto.$el.append(view.render().el)})}});var eventListView=new EventListView;return{"loadInitialShares":function(){shareListView.$el.find(".spinner").show();ws.common.ajax({"url":ws.stream.shareSource,"type":"GET"}).done(function(data){if(!data)return;if(data.comments)ws.comments.Manager.loadPageViewComments(data.comments);if(data.sharePage)ws.stream.addSharePage(data.sharePage)}).always(function(){shareListView.$el.find(".spinner").remove()})},"addSharePage":function(sharePage){ws.stream.shares.add(sharePage.digests);if(sharePage.more){shareListView.$el.append($("<div>").addClass("js-pager").data("nextPage",sharePage.page+1));pageCheck()}else shareListView.appendEndBlock();ws.stream.sharesUpdated(false)},"pageReplies":function(shareId,replyPage){ws.stream.shares.get(shareId).addReplyPage(replyPage)},"getYearFromStartDate":function(startDate){if(startDate.indexOf("-")>=0)return parseInt(startDate.split("-")[0],10);return new Date(1e3*parseInt(startDate,10)).getFullYear()},"typeToBlockType":function(type){switch(type){case"assignment":return"created";case"event":return"turn-in";case"comment":return"comment";case"discussion":return"announcement";default:return"announcement"}},"typeToIcon":function(type){switch(type){case"assignment":return"pencil";case"event":return"calendar";case"comment":return"comment-o";case"discussion":return"comment-o";case"announcement":return"bullhorn";default:return"comment-o"}return""},"typeToName":function(type){if("assignment"===type)return"Project";else return ws.common.ucfirst(type)},"highlightNewestShare":function(){_.defer(function(){$("#js-share-list > div .tc-timeline-box").eq(0).effect("highlight",{"color":"#FFC"},2500)})},"sharesUpdated":function(handleEndBlock){if(ws.stream.hideTimeline)return;_.defer(function(){if(0===ws.stream.shares.length){if(handleEndBlock)shareListView.detachEndBlock()}else if(handleEndBlock)shareListView.appendEndBlock();calculateVerticalLineHeight()})},"shares":shares,"upcoming":upcoming,"shareSource":"#","MAX_INITIAL_REPLIES":6,"replyTemplate":_.template($("#js-reply-template").html()),"rangeActionTemplate":_.template($("#js-range-action-template").html()),"userCanPostMessage":false,"ajaxifyForm":function(){var $form=$(".ws-stream-form");ws.common.ajaxifyForms($form);$form.on("ws-ajax-submit",function(event,ajax){var form=this;ajax.done(function(){if(form.reset)form.reset()})})},"initAddBlock":function(){$(".tc-add-block").on("click",openAddBlock);$(".tc-add-block .cancel").click(function(event){event.preventDefault();event.stopImmediatePropagation();event.stopPropagation();closeAddBlock()})},"closeAddBlock":closeAddBlock,"showUndoShareLink":function(shareId,title,callback){var attachHandler=function(pnotify){$("#undeleteShareId"+shareId).click(function(event){event.preventDefault();ws.common.ajax({"url":ws.common.pathFor("share","undelete",shareId)}).done(function(){pnotify.pnotify_remove();callback()}).fail(function(){$("#undeleteShareId"+shareId).show().next().hide()});$("#undeleteShareId"+shareId).hide().next().show()})};$.pnotify({"hide":false,"text":"<i>"+title+'</i> deleted <a href="#" id="undeleteShareId'+shareId+'">Undo</a><i class="fa fa-spinner fa-spin" style="display: none"></i>',"after_open":attachHandler})}}}(jQuery);
//# sourceMappingURL=stream.min.js.map